<!-- packages/ticket/pages/ticket/ticket.wxml -->
<view class="container">
  <!-- 顶部选项卡 -->
  <view class="tabs">
    <view class="tab {{activeTab === 'tickets' ? 'active' : ''}}" bindtap="switchTab" data-tab="tickets">购买门票</view>
    <view class="tab {{activeTab === 'orders' ? 'active' : ''}}" bindtap="switchTab" data-tab="orders">我的订单</view>
  </view>
  
  <!-- 购票内容 -->
  <block wx:if="{{activeTab === 'tickets'}}">
    <view class="section-title">选择门票</view>
    
    <!-- 门票列表 -->
    <view class="ticket-list ticket-selector">
      <view class="ticket-item {{item.selected ? 'selected' : ''}}" 
            wx:for="{{tickets}}" 
            wx:key="id"
            bindtap="selectTicket"
            data-id="{{item.id}}">
        <view class="ticket-info">
          <view class="ticket-name">{{item.name}}</view>
          <view class="ticket-desc">{{item.description}}</view>
          <view class="ticket-notice">{{item.notice}}</view>
        </view>
        <view class="ticket-price">
          <view class="price">¥{{item.price}}</view>
          <view class="original-price">¥{{item.originalPrice}}</view>
          <view class="discount">{{item.discount}}</view>
        </view>
      </view>
    </view>
    
    <!-- 门票数量 -->
    <view class="section-title">选择数量</view>
    <view class="quantity-selector">
      <view class="quantity-btn {{quantity <= 1 ? 'disabled' : ''}}" bindtap="changeQuantity" data-type="minus">-</view>
      <view class="quantity">{{quantity}}</view>
      <view class="quantity-btn {{quantity >= 10 ? 'disabled' : ''}}" bindtap="changeQuantity" data-type="add">+</view>
    </view>
    
    <!-- 游览日期 -->
    <view class="section-title">选择游览日期</view>
    <picker mode="date" value="{{visitDate}}" start="{{visitDate}}" end="2023-12-31" bindchange="bindDateChange">
      <view class="date-picker">
        <view>{{visitDate || '请选择游览日期'}}</view>
        <view class="arrow">></view>
      </view>
    </picker>
    
    <!-- 联系人信息表单 -->
    <block wx:if="{{showContactForm}}">
      <view class="section-title contact-form">联系人信息</view>
      <view class="form-group">
        <view class="form-item">
          <view class="label">姓名</view>
          <input class="input" placeholder="请输入联系人姓名" value="{{contactName}}" bindinput="onContactNameInput" />
        </view>
        
        <view class="form-item">
          <view class="label">手机号</view>
          <input class="input" type="number" maxlength="11" placeholder="请输入联系人手机号" value="{{contactPhone}}" bindinput="onContactPhoneInput" />
        </view>
        
        <view class="form-item">
          <view class="label">身份证号</view>
          <input class="input" placeholder="预留，部分门票可能需要" value="{{idCard}}" bindinput="onIdCardInput" />
        </view>
      </view>
    </block>
    
    <!-- 提交订单 -->
    <view class="total-section">
      <view class="total-price">总价: <text>¥{{totalPrice}}</text></view>
      <view class="submit-btn" bindtap="submitOrder">{{showContactForm ? '确认支付' : '下一步'}}</view>
    </view>
    
    <!-- 购票须知 -->
    <view class="notice-section">
      <view class="section-title">购票须知</view>
      <view class="notice-content">
        <view class="notice-item">1. 门票当天有效，请在有效期内使用</view>
        <view class="notice-item">2. 儿童票适用于1.2米-1.5米儿童，1.2米以下免票</view>
        <view class="notice-item">3. 老人票需持有效老人证，入园需出示</view>
        <view class="notice-item">4. 团队票需10人以上，请提前1天预订</view>
        <view class="notice-item">5. 门票一经售出，除特殊情况外不予退款</view>
      </view>
    </view>
  </block>
  
  <!-- 订单内容 -->
  <block wx:else>
    <view class="order-list">
      <view wx:if="{{orders.length === 0}}" class="empty-orders">
        <image src="/assets/icons/ticket/empty_order.png" mode="aspectFit" class="empty-icon"></image>
        <view class="empty-text">暂无订单</view>
      </view>
      <view wx:for="{{orders}}" wx:key="order_id" class="order-item">
        <view class="order-header">
          <view class="order-id">订单号: {{item.order_no || item.order_id}}</view>
          <view class="order-status {{item.status}}">
            {{item.status === 'UNPAID' ? '待支付' : 
              item.status === 'PAID' ? '待使用' : 
              item.status === 'USED' ? '已使用' : 
              item.status === 'REFUNDED' ? '已退款' : 
              item.status === 'REFUNDING' ? '退款中' : '已取消'
            }}
          </view>
        </view>
        <view class="order-content" bindtap="viewOrderDetail" data-id="{{item.order_id}}">
          <view class="order-info">
            <view class="order-name">{{item.ticket_name}} × {{item.quantity}}</view>
            <view class="order-date">游览日期: {{item.visit_date}}</view>
          </view>
          <view class="order-price">¥{{item.total_price}}</view>
        </view>
        <view class="order-footer">
          <view wx:if="{{item.status === 'PAID'}}" class="order-btn" bindtap="viewTicketCode" data-order="{{item}}">查看票码</view>
          <view wx:if="{{item.status === 'PAID'}}" class="order-btn refund" bindtap="requestRefund" data-id="{{item.order_id}}">申请退款</view>
        </view>
      </view>
    </view>
  </block>
</view>
